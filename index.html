<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MC Web iOS</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{margin:0;overflow:hidden;background:#000;font-family:sans-serif}
.btn,.slot{
 background:rgba(0,0,0,.6);
 color:#fff;
 border:2px solid #fff;
 border-radius:8px;
 padding:10px;
 font-size:14px;
}
#top,#inv,#ui,#hp{position:fixed;display:flex;gap:6px;z-index:10}
#top{top:10px;left:10px}
#inv{top:10px;left:50%;transform:translateX(-50%)}
#ui{bottom:10px;left:50%;transform:translateX(-50%)}
#hp{bottom:10px;left:10px}
.slot{width:40px;height:40px}
.active{border-color:yellow}
#look{position:fixed;right:0;top:0;width:50%;height:100%}
#joy{position:fixed;left:20px;bottom:20px;width:120px;height:120px;border:2px solid #fff;border-radius:50%}
#stick{position:absolute;left:40px;top:40px;width:40px;height:40px;border-radius:50%;background:#fff}
</style>
</head>
<body>

<div id="top">
 <div class="btn" id="save">üíæ</div>
 <div class="btn" id="load">üìÇ</div>
 <div class="btn" id="dev">DEV</div>
</div>

<div id="inv"></div>

<div id="ui">
 <div class="btn" id="jump">‚¨Ü</div>
 <div class="btn" id="build">‚õè</div>
 <div class="btn" id="destroy">‚ùå</div>
</div>

<div id="hp" class="btn">‚ù§ 100</div>

<div id="joy"><div id="stick"></div></div>
<div id="look"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
/* ========== THREE (iOS SAFE) ========== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87CEEB);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,500);
camera.position.set(0,2,5);

const renderer=new THREE.WebGLRenderer({antialias:false,powerPreference:"low-power"});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const sun=new THREE.DirectionalLight(0xffffff,0.6);
sun.position.set(5,10,5);
scene.add(sun);

/* ========== TEXTURES ========== */
const loader=new THREE.TextureLoader();
const textures={
 grass:loader.load("https://i.imgur.com/8IhKxXc.png"),
 dirt:loader.load("https://i.imgur.com/1Q9Z1Zm.png"),
 stone:loader.load("https://i.imgur.com/Zc5Zk1F.png")
};
const material=t=>new THREE.MeshStandardMaterial({map:textures[t]});

/* ========== WORLD ========== */
const blocks={};
const key=(x,y,z)=>`${x},${y},${z}`;

function addBlock(x,y,z,type){
 const k=key(x,y,z);
 if(blocks[k])return;
 const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),material(type));
 m.position.set(x,y,z);
 m.userData={x,y,z,type};
 scene.add(m);
 blocks[k]=m;
}

function removeBlock(x,y,z){
 const k=key(x,y,z);
 if(!blocks[k])return;
 scene.remove(blocks[k]);
 delete blocks[k];
}

/* ========== GENERATE WORLD ========== */
for(let x=-6;x<=6;x++)
for(let z=-6;z<=6;z++){
 addBlock(x,0,z,"grass");
 if(Math.random()>0.7)addBlock(x,-1,z,"dirt");
}

/* ========== SAVE / LOAD ========== */
save.onclick=()=>{
 localStorage.setItem("world",JSON.stringify(Object.values(blocks).map(b=>b.userData)));
};

load.onclick=()=>{
 const d=JSON.parse(localStorage.getItem("world"));
 if(!d)return;
 Object.values(blocks).forEach(b=>scene.remove(b));
 for(const k in blocks)delete blocks[k];
 d.forEach(b=>addBlock(b.x,b.y,b.z,b.type));
};

/* ========== INVENTORY ========== */
const inventory=["grass","dirt","stone"];
let current=0;
const invDiv=document.getElementById("inv");

inventory.forEach((_,i)=>{
 const s=document.createElement("div");
 s.className="slot"+(i===0?" active":"");
 s.onclick=()=>{
  current=i;
  document.querySelectorAll(".slot").forEach(e=>e.classList.remove("active"));
  s.classList.add("active");
 };
 invDiv.appendChild(s);
});

/* ========== PLAYER ========== */
let vy=0,grounded=false,fly=false;
let hp=100;
const gravity=0.015,speed=0.08;
let mx=0,mz=0;

/* ========== JOYSTICK MOVE ========== */
const joy=document.getElementById("joy");
const stick=document.getElementById("stick");

joy.ontouchmove=e=>{
 const r=joy.getBoundingClientRect();
 mx=(e.touches[0].clientX-r.left-60)/40;
 mz=(e.touches[0].clientY-r.top-60)/40;
 mx=Math.max(-1,Math.min(1,mx));
 mz=Math.max(-1,Math.min(1,mz));
 stick.style.left=40+mx*40+"px";
 stick.style.top=40+mz*40+"px";
};
joy.ontouchend=()=>{mx=mz=0;stick.style.left=stick.style.top="40px"};

/* ========== TOUCH LOOK (iOS FIX) ========== */
let lx=0,ly=0;
const look=document.getElementById("look");

look.ontouchstart=e=>{
 lx=e.touches[0].clientX;
 ly=e.touches[0].clientY;
};

look.ontouchmove=e=>{
 const dx=(e.touches[0].clientX-lx)*0.005;
 const dy=(e.touches[0].clientY-ly)*0.005;
 camera.rotation.y-=dx;
 camera.rotation.x=Math.max(-1.5,Math.min(1.5,camera.rotation.x-dy));
 lx=e.touches[0].clientX;
 ly=e.touches[0].clientY;
};

/* ========== ACTIONS ========== */
jump.onclick=()=>{
 if(grounded||fly){vy=0.25;grounded=false;}
};

build.onclick=()=>{
 const d=new THREE.Vector3();
 camera.getWorldDirection(d);
 const p=camera.position.clone().add(d.multiplyScalar(2));
 addBlock(Math.round(p.x),Math.round(p.y),Math.round(p.z),inventory[current]);
};

destroy.onclick=()=>{
 const d=new THREE.Vector3();
 camera.getWorldDirection(d);
 const p=camera.position.clone().add(d.multiplyScalar(2));
 removeBlock(Math.round(p.x),Math.round(p.y),Math.round(p.z));
};

dev.onclick=()=>{fly=!fly};

/* ========== LOOP ========== */
function loop(){
 requestAnimationFrame(loop);

 camera.position.x+=(-Math.sin(camera.rotation.y)*mz+Math.cos(camera.rotation.y)*mx)*speed;
 camera.position.z+=(-Math.cos(camera.rotation.y)*mz-Math.sin(camera.rotation.y)*mx)*speed;

 if(!fly){
  vy-=gravity;
  camera.position.y+=vy;
  if(camera.position.y<2){
   camera.position.y=2;
   vy=0;
   grounded=true;
  }
 }

 renderer.render(scene,camera);
}
loop();

addEventListener("resize",()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>